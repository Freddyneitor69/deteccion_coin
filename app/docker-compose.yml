version: "3.8"
services:
  yolo:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        L4T_TAG: r32.7.1
    container_name: jetson-yolo-coins
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # Config de inferencia
      - INFER_SOURCE=0        # 0 | /workspace/in.mp4 | pipeline GStreamer
      - IMG_SIZE=640
      - CONF_THRES=0.25
      - HALF=1                # FP16 (solo .pt). En TRT no aplica
      - USE_TRT=0             # 1 para exportar/usar TensorRT en Nano
      - SHOW=1                # 1 = abrir ventana con cv2.imshow
      # X11 para mostrar ventana desde el contenedor
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    devices:
      - "/dev/video0:/dev/video0"     # USB cam
    volumes:
      - ../models:/workspace/models   # best.pt/engine fuera del contenedor
      - ../out:/workspace/out
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
      # Para cámara CSI (Raspberry) descomenta estas dos líneas:
      # - /tmp/argus_socket:/tmp/argus_socket
    # Para cámara CSI, también suele requerirse:
    # privileged: true
    restart: unless-stopped
